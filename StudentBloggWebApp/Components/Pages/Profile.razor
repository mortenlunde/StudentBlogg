@page "/Profile"
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using StudentBlogg.Feature.Users
@inject HttpClient Http
@inject ProtectedLocalStorage ProtectedBrowserStorage
@using System.IdentityModel.Tokens.Jwt

<h1>Profil</h1>
<hr/>
<br/>

@if (_isLoading)
{
    <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
}
else if (_userRegistrationDto != null)
{
    <div style="width: 100%; max-width: 33%">
    <NavLink href="/createpost" class="btn btn-primary">Opprett nytt innlegg</NavLink>
    <br/><br/>
    <EditForm Model="_userRegistrationDto" OnValidSubmit="SaveChanges">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group">
            <label for="Username">Brukernavn</label>
            <InputText id="Username" class="form-control" @bind-Value="_userRegistrationDto.Username" />
        </div>

        <div class="form-group">
            <label for="FirstName">Fornavn</label>
            <InputText id="FirstName" class="form-control" @bind-Value="_userRegistrationDto.Firstname" />
        </div>

        <div class="form-group">
            <label for="LastName">Etternavn</label>
            <InputText id="LastName" class="form-control" @bind-Value="_userRegistrationDto.Lastname" />
        </div>

        <div class="form-group">
            <label for="Email">Email</label>
            <InputText id="Email" class="form-control" @bind-Value="_userRegistrationDto.Email" />
        </div>

        <!-- Add password fields -->
        <div class="form-group">
            <label for="Password">Passord</label>
            <InputText id="Password" type="password" class="form-control" @bind-Value="_userRegistrationDto.Password" />
            <small class="form-text text-muted">La være blank for å beholde eksisterende.</small>
        </div><br/>


        <button type="submit" class="btn btn-primary">Lagre endringer</button>
    </EditForm>
    </div>
}
else
{
    <p>No user data available.</p>
}

@code {
    private UserRegistrationDto _userRegistrationDto = new UserRegistrationDto();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var tokenResult = await ProtectedBrowserStorage.GetAsync<string>("authToken");
            if (tokenResult.Success && !string.IsNullOrEmpty(tokenResult.Value))
            {
                string? token = tokenResult.Value;

                // Decode the JWT token to get the user ID
                var handler = new JwtSecurityTokenHandler();
                var jwtToken = handler.ReadJwtToken(token);
                var userIdClaim = jwtToken.Claims.FirstOrDefault(c => c.Type == "UserId");

                if (userIdClaim != null)
                {
                    var userId = userIdClaim.Value;

                    // Add the token to the Authorization header
                    Http.DefaultRequestHeaders.Authorization =
                        new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

                    // Fetch the user data
                    var response = await Http.GetFromJsonAsync<UserDto>($"api/v1/Users/{userId}");

                    if (response != null)
                    {
                        // Map the fetched UserDto to UserRegistrationDto
                        _userRegistrationDto = new UserRegistrationDto
                        {
                            Username = response.Username,
                            Firstname = response.FirstName,
                            Lastname = response.LastName,
                            Email = response.Email
                        };
                    }
                    else
                    {
                        await Console.Error.WriteLineAsync("No data returned from API.");
                    }
                }
                else
                {
                    await Console.Error.WriteLineAsync("UserId claim not found in token.");
                }
            }
            else
            {
                await Console.Error.WriteLineAsync("Token not found or invalid.");
            }
        }
        catch (Exception ex)
        {
            await Console.Error.WriteLineAsync($"Error fetching user data: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SaveChanges()
    {
        try
        {
            var tokenResult = await ProtectedBrowserStorage.GetAsync<string>("authToken");
            if (tokenResult.Success && !string.IsNullOrEmpty(tokenResult.Value))
            {
                var token = tokenResult.Value;
                var handler = new JwtSecurityTokenHandler();
                var jwtToken = handler.ReadJwtToken(token);
                var userIdClaim = jwtToken.Claims.FirstOrDefault(c => c.Type == "UserId");

                var userId = Guid.Parse(userIdClaim!.Value);

                Http.DefaultRequestHeaders.Authorization =
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

                var response = await Http.PutAsJsonAsync($"api/v1/Users/{userId}", _userRegistrationDto);

                if (response.IsSuccessStatusCode)
                {
                    Console.WriteLine("User updated successfully!");
                }
                else
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    await Console.Error.WriteLineAsync($"Failed to update user: {errorContent}");
                }
            }
        }
        catch (Exception ex)
        {
            await Console.Error.WriteLineAsync($"Error updating user data: {ex.Message}");
        }
    }

}